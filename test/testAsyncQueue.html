<html>
    <head>
        <!-- load just the basic support -->
        <script src="/ext/jquery/jquery-1.10.2.min.js"></script>
        <script src="/ext/q/q.min.js"></script>
        <script src="/ext/underscore/1.7.0/underscore-min.js"></script>
        <script src="/ext/postal/postal-0.12.4.min.js"></script>
        <script src="/ext/postal/postal.request-response-0.3.1.min.js"></script>
        <script src="/ext/postal/postal-deluxe.js"></script>
        <script src="/ext/requirejs/2.1.15/require.js"></script>
        <script src="/functional-site/js/require-config.js"></script>
        <script src="/ext/kbase-clients/kbase-client-api.min.js"></script>
    </head>

    <body>
        <h1>Testing for KBase AsyncQueue</h1>
        <h2>Presence of the Module</h2>
        <div data-test="presence">
            <div>Result: <span data-field="result"></span></div>
            
        </div>
        <script>
            require(['kb.asyncqueue'], function (O) {
                if (O) {
                    document.querySelector('[data-test="presence"] [data-field="result"]').innerHTML = 'success';
                } else {
                    document.querySelector('[data-test="presence"] [data-field="result"]').innerHTML = 'failure';
                }
            });
        </script>

        <h2>Version - static</h2>
        <div data-test="version"></div>
        <script>
            require(['kb.asyncqueue', 'kb.test'], function (O, Tester) {
                var tests = [
                    {
                        expects: {
                            propertyValue: '0.0.2',
                            status: 'success'
                        }
                    }
                ];
                
                 var T = Object.create(Tester).init({
                    type: 'property',
                    propertyName: 'version',
                    id: 'version',
                    tests: tests,
                    object: O
                }).runTests();
            });
        </script>

        <h2>Version - new object</h2>
        <div data-test="version2"></div>
        <script>
            require(['kb.asyncqueue', 'kb.test'], function (O, Tester) {
                 var tests = [
                    {
                        expects: {
                            propertyValue: '0.0.2',
                            status: 'success'
                        }
                    }
                ];
                
                 var T = Object.create(Tester).init({
                    type: 'property',
                    propertyName: 'version',
                    id: 'version2',
                    tests: tests,
                    object: Object.create(O)
                }).runTests();
            });
        </script>
            
            
        <h2>addItem</h2>
        <div data-test="addItem"></div>
        <script>
            require(['kb.asyncqueue', 'kb.test'], function (O, Tester) {
                var tests = [
                    {
                        expects: {
                            input: [{onRun: function () {console.log('Live long, and prosper');}}],
                            ignoreMutation: true,
                            // mutation: none
                            output: function () {return this.getObject();},
                            
                            description: 'Set a simple property on a simple object'
                        }
                    }
                ];

                var T = Object.create(Tester).init({
                    id: 'addItem',
                    description: 'Add an item to the queue and ensure that it is run within the expected time frame.',
                    tests: tests,
                    object: Object.create(O).init(),
                    method: 'addItem'
                }).runTests();
            });
        </script>

        <h2>addManyItems</h2>
        <div data-test="addManyItems"></div>
        <script>
            require(['kb.asyncqueue', 'kb.test'], function (O, Tester) {
                var tests = [
                    {
                        expects: {
                            input: [],
                            ignoreMutation: true,
                            // mutation: none
                            output: true,
                            description: 'Queue many items by way of a test function'
                        }
                    }
                ];

                var T = Object.create(Tester).init({
                    id: 'addManyItems',
                    description: 'Add an item to the queue and ensure that it is run within the expected time frame.',
                    tests: tests,
                    object: Object.create(O).init(),
                    testRunner: function () {
                        var aq = this.getObject();
                        var i;
                        var limit = 1000;
                        console.log('about to add 1000 items');
                        for (i = 0; i < limit; i += 1) {
                            aq.addItem({
                                onRun: (function (id) {
                                    return function () {
                                        console.log('This is item ' + id);
                                    };
                                }(i))
                            });
                        }
                        console.log('added 1000 items. Now they should appear in the log');
                        return true;
                    },
                    method: 'addItem'
                }).runTests();
            });
        </script>
            
            
        <h2>addItemsWhichAddItems</h2>
        <div data-test="addItemsWhichAddItems"></div>
        <script>
            require(['kb.asyncqueue', 'kb.test'], function (O, Tester) {
                var tests = [
                    {
                        expects: {
                            input: [],
                            ignoreMutation: true,
                            // mutation: none
                            output: true,
                            description: 'Queue many items by way of a test function'
                        }
                    }
                ];

                var T = Object.create(Tester).init({
                    id: 'addItemsWhichAddItems',
                    description: 'Adds a few items, which in turn each add a few items. See where this goes!',
                    tests: tests,
                    object: Object.create(O).init(),
                    testRunner: function () {
                        var aq = this.getObject();
                        var i;
                        var limit = 1000;
                        console.log('about to add 20 items');
                        for (i = 0; i < limit; i += 1) {
                            aq.addItem({
                                onRun: (function (i) {
                                    return function (queue) {
                                        console.log('This is item ' + i);
                                        console.log('adding my own items now!');
                                        var j;
                                        var limit = 100;
                                        for (j = 0; j < limit; j += 1) {
                                            queue.addItem({
                                                onRun: (function (j) {
                                                    return function () {
                                                        console.log('I am sub-task '+j+' from item: '+i);
                                                    };
                                                }(j))
                                            });
                                        }
                                    };
                                }(i))
                            });
                        }
                        console.log('added 20 items. Now they should appear in the log');
                        return true;
                    },
                    method: 'addItem'
                }).runTests();
            });
        </script>   
            
    </body>

</html>

